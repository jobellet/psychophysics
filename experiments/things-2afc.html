<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Things Image Matching (2AFC)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="../jspsych/css/jspsych.css" />
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        --page-bg: radial-gradient(circle at top, #0f172a 0%, #020617 100%);
        --panel-bg: rgba(15, 23, 42, 0.82);
        --panel-border: 1px solid rgba(148, 163, 184, 0.28);
        --accent: #60a5fa;
        --accent-muted: rgba(96, 165, 250, 0.15);
        --text-primary: #e2e8f0;
        --text-secondary: rgba(203, 213, 225, 0.88);
        --layout-padding: clamp(16px, 4vw, 48px);
        --card-width: min(960px, 100vw - (var(--layout-padding) * 2));
        --afc-gap: clamp(12px, 2.4vw, 32px);
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: clamp(18px, 4vw, 32px);
        padding: var(--layout-padding);
        background: var(--page-bg);
        color: var(--text-primary);
      }

      a { color: var(--accent); }

      .card {
        width: var(--card-width);
        border: var(--panel-border);
        border-radius: clamp(18px, 3vw, 28px);
        background: var(--panel-bg);
        padding: clamp(20px, 4vw, 36px);
        box-shadow: 0 22px 50px rgba(2, 6, 23, 0.5);
        display: flex;
        flex-direction: column;
        gap: clamp(14px, 3vw, 24px);
      }

      .card h1 {
        margin: 0;
        font-size: clamp(1.6rem, 4vw, 2.2rem);
      }

      .card p {
        margin: 0;
        color: var(--text-secondary);
        line-height: 1.55;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }

      button {
        appearance: none;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(30, 41, 59, 0.65);
        color: inherit;
        font: inherit;
        padding: 10px 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 160ms ease, transform 160ms ease, border-color 160ms ease;
      }

      button.primary {
        background: linear-gradient(135deg, #38bdf8, #2563eb);
        color: #f8fafc;
        border: none;
        box-shadow: inset 0 -2px 0 rgba(8, 47, 73, 0.35);
      }

      button:hover:not(:disabled) {
        background: rgba(51, 65, 85, 0.85);
        transform: translateY(-1px);
      }

      button.primary:hover:not(:disabled) {
        background: linear-gradient(135deg, #60a5fa, #2563eb);
      }

      button:disabled {
        opacity: 0.45;
        cursor: not-allowed;
        transform: none;
      }

      .status-bar {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 0.95rem;
        color: rgba(226, 232, 240, 0.82);
      }

      .status-bar strong {
        color: var(--text-primary);
      }

      .hidden { display: none !important; }

      #jspsych-target {
        width: min(1280px, 100vw - (var(--layout-padding) * 2));
        min-height: clamp(280px, 58vh, 720px);
        border-radius: clamp(18px, 3vw, 28px);
        border: var(--panel-border);
        background: rgba(15, 23, 42, 0.72);
        box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.12);
        padding: clamp(18px, 4vw, 32px);
        display: none;
        margin: 0 auto;
      }

      #jspsych-target.active { display: block; }

      .afc-trial {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: clamp(18px, 4vw, 28px);
        width: 100%;
      }

      .afc-instructions {
        font-size: clamp(1rem, 2.2vw, 1.25rem);
        text-align: center;
        color: var(--text-secondary);
      }

      .afc-stage {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .afc-stage-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--afc-gap);
        width: 100%;
        max-width: min(1200px, 100%);
      }

      .afc-slot {
        flex: 0 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .afc-slot--reference {
        gap: clamp(8px, 1.6vw, 16px);
      }

      .afc-reference-frame {
        padding: clamp(8px, 1.8vw, 16px);
        border-radius: clamp(14px, 2.6vw, 22px);
        background: rgba(15, 23, 42, 0.9);
        box-shadow: 0 18px 42px rgba(2, 6, 23, 0.45);
      }

      .afc-reference-frame img {
        display: block;
        width: min(28vh, clamp(90px, 24vw, 320px));
        height: min(28vh, clamp(90px, 24vw, 320px));
        object-fit: cover;
        border-radius: clamp(12px, 2vw, 18px);
      }

      .afc-reference-label {
        font-size: clamp(0.85rem, 1.8vw, 1rem);
        color: rgba(226, 232, 240, 0.72);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      #jspsych-html-button-response-btngroup,
      .afc-choice-group {
        display: contents;
      }

      .jspsych-html-button-response-button {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .afc-choice {
        background: rgba(15, 23, 42, 0.9);
        border-radius: clamp(16px, 2.8vw, 22px);
        border: 1px solid rgba(148, 163, 184, 0.28);
        padding: clamp(8px, 1.6vw, 16px);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 16px 36px rgba(2, 6, 23, 0.45);
        transition: transform 120ms ease, box-shadow 120ms ease;
      }

      .afc-choice img {
        width: min(28vh, clamp(90px, 24vw, 320px));
        height: min(28vh, clamp(90px, 24vw, 320px));
        object-fit: cover;
        border-radius: clamp(12px, 2vw, 18px);
        pointer-events: none;
      }

      .afc-choice:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 20px 40px rgba(2, 6, 23, 0.55);
      }

      .afc-choice:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 3px;
      }

      .afc-help {
        font-size: 0.95rem;
        text-align: center;
        color: rgba(148, 163, 184, 0.9);
        margin-top: clamp(10px, 2vw, 18px);
      }

      .completion-message {
        color: #a7f3d0;
        font-weight: 600;
      }

      .error-message {
        color: #fca5a5;
        font-weight: 600;
      }

      @media (max-width: 960px) {
        #jspsych-target {
          width: min(100vw - (clamp(12px, 3vw, 24px) * 2), 960px);
          padding: clamp(16px, 5vw, 28px);
        }
      }

      @media (max-width: 720px) {
        body {
          padding: clamp(12px, 4vw, 28px);
        }
        :root {
          --card-width: min(960px, 100vw - (clamp(12px, 4vw, 28px) * 2));
        }
        .afc-stage-row {
          gap: clamp(10px, 3vw, 18px);
        }
        .afc-reference-frame img,
        .afc-choice img {
          width: min(26vh, clamp(80px, 30vw, 220px));
          height: min(26vh, clamp(80px, 30vw, 220px));
        }
      }

      @media (max-width: 520px) {
        .afc-stage-row {
          gap: clamp(8px, 3vw, 14px);
        }
        .afc-reference-frame img,
        .afc-choice img {
          width: clamp(72px, 28vw, 160px);
          height: clamp(72px, 28vw, 160px);
        }
      }
    </style>
  </head>
  <body>
    <section class="card" id="intro-card">
      <h1>Things Image Matching (2AFC)</h1>
      <p>
        On each trial you will see a reference image in the centre and two images on the sides.
        Choose the side that shows the version of the object that matches the reference image.
        Use the left and right arrow keys on a keyboard or tap the image directly on touch devices.
      </p>
      <p>
        Every neutral reference image is presented twice: once paired with its prototypical variant and once with its outlier variant.
        Trials are precomputed and the experiment will end after all trials have been completed, but you may stop at any time and download your data.
      </p>
      <div class="controls">
        <button class="primary" id="start-button" disabled>Preparing stimuli…</button>
        <button id="stop-button" disabled>Stop</button>
        <button id="download-csv" disabled>Download CSV</button>
        <button id="download-json" disabled>Download JSON</button>
      </div>
      <div class="status-bar">
        <span id="stimulus-status">Loading stimulus manifest…</span>
        <span id="progress-status">Trials prepared: 0</span>
        <span id="message-area"></span>
      </div>
    </section>

    <div id="jspsych-target"></div>

    <script src="../jspsych/dist/jspsych.js"></script>
    <script src="../jspsych/plugins/html-button-response.js"></script>
    <script type="module" src="things-2afc.js"></script>
  </body>
</html>
